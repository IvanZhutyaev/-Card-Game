<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –°–µ–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #0a1a3a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Arial Narrow', Arial, sans-serif;
            position: relative;
        }
        
        .main-area {
            flex: 3;
            position: relative;
        }
        
        .menu-button {
            position: absolute;
            top: 15px;
            left: 35px;
            width: 40px;
            height: 40px;
            background: url('static/dropdownMenuGameplay.png') no-repeat center;
            background-size: contain;
            border: none;
            cursor: pointer;
            z-index: 100;
        }
        
        .center-block {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 520px;
            height: 40px;
            background-color: white;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 90;
        }
        
        .player-turn-info {
            font-size: 16px;
            font-weight: normal;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }
        
        .top-right-buttons {
            position: absolute;
            top: 15px;
            right: 35px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .sound-button, .exit-button {
            width: 40px;
            height: 40px;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
        }
        
        .sound-button {
            background: url('static/volumeGameplay.png') no-repeat center;
            background-size: contain;
        }
        
        .exit-button {
            background: url('static/exitGameplay.png') no-repeat center;
            background-size: contain;
        }
        
        .players-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            display: flex;
            justify-content: space-between;
            z-index: 50;
        }
        
        .players-left, .players-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            transition: all 0.3s ease;
            opacity: 0.6;
        }
        
        .player-card.active {
            opacity: 1;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            border: 2px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .player-action {
            margin-top: 5px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            text-align: center;
            min-width: 70px;
        }
        
        .player-name {
            margin-top: 5px;
            color: white;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }
        
        .player-balance {
            margin-top: 3px;
            color: #FFD700;
            font-size: 12px;
            text-align: center;
        }
        
        .game-title {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-size: 48px;
            font-weight: normal;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        
        .bank-title {
            position: absolute;
            top: 80%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-size: 24px;
            font-weight: normal;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        
        .bank-amount {
            position: absolute;
            top: 85%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-size: 18px;
            font-weight: normal;
            z-index: 50;
        }
        
        .bottom-panel {
            flex: 1;
            background-color: #020c21;
            border-top: 2px solid #fff;
        }

        .dropdown-menu {
            position: absolute;
            top: 60px;
            left: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            padding: 10px 0;
            width: 200px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            font-weight: normal;
        }
        
        .dropdown-menu a:hover {
            background-color: #f0f0f0;
        }
        
        .current-player {
            transform: scale(1.05);
            box-shadow: 0 0 15px gold;
        }
        
        @media (max-width: 768px) {
            .center-block {
                width: 80%;
                height: 35px;
            }
            
            .game-title {
                font-size: 36px;
                top: 15%;
            }
            
            .bank-title {
                font-size: 20px;
                top: 75%;
            }
            
            .bank-amount {
                font-size: 16px;
                top: 80%;
            }
            
            .player-card {
                width: 80px;
            }
            
            .player-avatar {
                width: 50px;
                height: 50px;
                font-size: 16px;
            }
            
            .player-action {
                font-size: 10px;
                min-width: 60px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-balance {
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .game-title {
                font-size: 28px;
            }
            
            .bank-title {
                font-size: 18px;
            }
            
            .bank-amount {
                font-size: 14px;
                padding: 6px 15px;
            }
            
            .player-turn-info {
                font-size: 14px;
            }
            
            .players-container {
                width: 95%;
            }
            
            .player-card {
                width: 70px;
            }
            
            .player-avatar {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="main-area">
        <button class="menu-button" id="menuButton"></button>
        
        <div class="center-block">
            <div class="player-turn-info" id="playerTurnInfo">
                –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...
            </div>
        </div>
        
        <div class="top-right-buttons">
            <button class="sound-button" id="soundButton"></button>
            <button class="exit-button" id="exitButton"></button>
        </div>
        
        <div class="dropdown-menu" id="dropdownMenu">
            <a href="rules.html">üìú–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</a>
            <a href="history.html">üìä–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</a>
            <a href="invite.html">üë•–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</a>
        </div>
        
        <div class="game-title">–°–µ–∫–∞</div>
        
        <div class="players-container">
            <div class="players-left" id="playersLeft">
                <!-- –°–ª–æ—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ —Å–ª–µ–≤–∞ -->
                <div class="player-card" id="player-slot-1">
                    <div class="player-avatar">?</div>
                    <div class="player-action">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="player-name">–ò–≥—Ä–æ–∫ 1</div>
                    <div class="player-balance">$ 0.00</div>
                </div>
                <div class="player-card" id="player-slot-2">
                    <div class="player-avatar">?</div>
                    <div class="player-action">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="player-name">–ò–≥—Ä–æ–∫ 2</div>
                    <div class="player-balance">$ 0.00</div>
                </div>
                <div class="player-card" id="player-slot-3">
                    <div class="player-avatar">?</div>
                    <div class="player-action">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="player-name">–ò–≥—Ä–æ–∫ 3</div>
                    <div class="player-balance">$ 0.00</div>
                </div>
            </div>
            <div class="players-right" id="playersRight">
                <!-- –°–ª–æ—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ —Å–ø—Ä–∞–≤–∞ -->
                <div class="player-card" id="player-slot-4">
                    <div class="player-avatar">?</div>
                    <div class="player-action">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="player-name">–ò–≥—Ä–æ–∫ 4</div>
                    <div class="player-balance">$ 0.00</div>
                </div>
                <div class="player-card" id="player-slot-5">
                    <div class="player-avatar">?</div>
                    <div class="player-action">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="player-name">–ò–≥—Ä–æ–∫ 5</div>
                    <div class="player-balance">$ 0.00</div>
                </div>
                <div class="player-card" id="player-slot-6">
                    <div class="player-avatar">?</div>
                    <div class="player-action">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="player-name">–ò–≥—Ä–æ–∫ 6</div>
                    <div class="player-balance">$ 0.00</div>
                </div>
            </div>
        </div>
        
        <div class="bank-title">–ë–∞–Ω–∫</div>
        <div class="bank-amount" id="bankAmount">$ 0.00</div>
    </div>
    
    <div class="bottom-panel"></div>

    <script>
        class GameController {
            constructor() {
                this.tgUser = null;
                this.gameState = {
                    players: [],
                    bankAmount: 0,
                    currentTurn: null,
                    playerSlots: 6 // –í—Å–µ–≥–æ —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤
                };
                this.socket = null;
                this.playerColors = [
                    '#FF5733', '#33FF57', '#3357FF', '#F333FF', '#33FFF3',
                    '#FF33F3', '#33FFBD', '#FFBD33', '#8D33FF', '#33A2FF'
                ];
                
                this.init();
            }
            
            async init() {
                this.initTelegramWebApp();
                this.setupEventListeners();
                await this.loadInitialData();
                this.connectWebSocket();
            }
            
            initTelegramWebApp() {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.expand();
                    this.tgUser = Telegram.WebApp.initDataUnsafe?.user;
                    
                    if (this.tgUser) {
                        document.getElementById('playerTurnInfo').textContent = 
                            `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${this.tgUser.first_name || '–ò–≥—Ä–æ–∫'}!`;
                    }
                }
            }
            
            setupEventListeners() {
                document.getElementById('menuButton').addEventListener('click', () => {
                    const menu = document.getElementById('dropdownMenu');
                    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                });
                
                document.getElementById('soundButton').addEventListener('click', () => {
                    alert('–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –∑–≤—É–∫–∞');
                });
                
                document.getElementById('exitButton').addEventListener('click', () => {
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                        if (this.socket) this.socket.close();
                        Telegram.WebApp.close();
                    }
                });
                
                document.addEventListener('click', (event) => {
                    const menu = document.getElementById('dropdownMenu');
                    const button = document.getElementById('menuButton');
                    
                    if (event.target !== button && !menu.contains(event.target)) {
                        menu.style.display = 'none';
                    }
                });
            }
            
            async loadInitialData() {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                    const gameResponse = await fetch('/get_game_state');
                    const gameState = await gameResponse.json();
                    this.updateGameState(gameState);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                }
            }
            
            connectWebSocket() {
                if (!this.tgUser) return;
                
                const socketUrl = `ws://${window.location.host}/ws/${this.tgUser.id}`;
                this.socket = new WebSocket(socketUrl);
                
                this.socket.onopen = () => {
                    console.log('WebSocket connected');
                    this.socket.send(JSON.stringify({
                        action: 'join',
                        player_id: this.tgUser.id
                    }));
                };
                
                this.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleSocketMessage(data);
                };
                
                this.socket.onclose = () => {
                    console.log('WebSocket disconnected');
                };
            }
            
            handleSocketMessage(data) {
                switch (data.type) {
                    case 'player_update':
                        this.updatePlayer(data.data);
                        break;
                    case 'game_state':
                        this.updateGameState(data.data);
                        break;
                    case 'new_message':
                        this.showGameMessage(data.message);
                        break;
                }
            }
            
            updatePlayer(playerData) {
                // –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                let slotUpdated = false;
                
                for (let i = 1; i <= this.gameState.playerSlots; i++) {
                    const slot = document.getElementById(`player-slot-${i}`);
                    if (slot.dataset.playerId === playerData.id) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                        this.fillPlayerSlot(i, playerData);
                        slotUpdated = true;
                        break;
                    }
                }
                
                if (!slotUpdated) {
                    // –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                    for (let i = 1; i <= this.gameState.playerSlots; i++) {
                        const slot = document.getElementById(`player-slot-${i}`);
                        if (!slot.dataset.playerId) {
                            this.fillPlayerSlot(i, playerData);
                            slot.dataset.playerId = playerData.id;
                            slot.classList.add('active');
                            break;
                        }
                    }
                }
            }
            
            fillPlayerSlot(slotNumber, playerData) {
                const slot = document.getElementById(`player-slot-${slotNumber}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
                const avatar = slot.querySelector('.player-avatar');
                if (playerData.photo_url) {
                    avatar.style.backgroundImage = `url('${playerData.photo_url}')`;
                    avatar.textContent = '';
                } else {
                    const initials = (playerData.first_name?.[0] || '') + (playerData.last_name?.[0] || '');
                    avatar.style.backgroundColor = this.playerColors[Math.floor(Math.random() * this.playerColors.length)];
                    avatar.textContent = initials;
                    avatar.style.backgroundImage = 'none';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è
                const name = slot.querySelector('.player-name');
                name.textContent = playerData.first_name + (playerData.last_name ? ` ${playerData.last_name}` : '');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                const balance = slot.querySelector('.player-balance');
                balance.textContent = `$ ${(playerData.balance || 0).toFixed(2)}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                const action = slot.querySelector('.player-action');
                if (playerData.action) {
                    action.textContent = playerData.action;
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
                    if (playerData.action === "–•–æ–¥–∏—Ç") {
                        action.style.backgroundColor = "rgba(0, 150, 0, 0.5)";
                    } else if (playerData.action === "–ü–∞—Å") {
                        action.style.backgroundColor = "rgba(150, 0, 0, 0.5)";
                    } else if (playerData.action === "–û–ø–ª–∞—Ç–∏–ª") {
                        action.style.backgroundColor = "rgba(0, 0, 150, 0.5)";
                    } else {
                        action.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
                    }
                }
                
                // –ü–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                if (playerData.is_current) {
                    slot.classList.add('current-player');
                } else {
                    slot.classList.remove('current-player');
                }
            }
            
            updateGameState(gameState) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–Ω–∫
                if (gameState.bankAmount !== undefined) {
                    this.gameState.bankAmount = gameState.bankAmount;
                    document.getElementById('bankAmount').textContent = `$ ${gameState.bankAmount.toFixed(2)}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ–¥
                if (gameState.currentTurn !== undefined) {
                    this.gameState.currentTurn = gameState.currentTurn;
                    document.getElementById('playerTurnInfo').textContent = 
                        `–û—á–µ—Ä–µ–¥—å –∏–≥—Ä–æ–∫–∞: ${gameState.currentTurn}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤
                if (gameState.players) {
                    // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å–ª–æ—Ç—ã
                    for (let i = 1; i <= this.gameState.playerSlots; i++) {
                        const slot = document.getElementById(`player-slot-${i}`);
                        slot.dataset.playerId = '';
                        slot.classList.remove('active');
                        slot.querySelector('.player-avatar').textContent = '?';
                        slot.querySelector('.player-avatar').style.backgroundImage = '';
                        slot.querySelector('.player-avatar').style.backgroundColor = '#ccc';
                        slot.querySelector('.player-name').textContent = `–ò–≥—Ä–æ–∫ ${i}`;
                        slot.querySelector('.player-balance').textContent = '$ 0.00';
                        slot.querySelector('.player-action').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ';
                        slot.querySelector('.player-action').style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
                        slot.classList.remove('current-player');
                    }
                    
                    // –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–ª–æ—Ç—ã
                    gameState.players.forEach((player, index) => {
                        const slotNumber = index + 1;
                        if (slotNumber <= this.gameState.playerSlots) {
                            const slot = document.getElementById(`player-slot-${slotNumber}`);
                            this.fillPlayerSlot(slotNumber, player);
                            slot.dataset.playerId = player.id;
                            slot.classList.add('active');
                        }
                    });
                }
            }
            
            showGameMessage(message) {
                const turnInfo = document.getElementById('playerTurnInfo');
                turnInfo.textContent = message;
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                if (this.gameState.currentTurn) {
                    setTimeout(() => {
                        turnInfo.textContent = `–û—á–µ—Ä–µ–¥—å –∏–≥—Ä–æ–∫–∞: ${this.gameState.currentTurn}`;
                    }, 3000);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            new GameController();
        });
    </script>
</body>
</html>